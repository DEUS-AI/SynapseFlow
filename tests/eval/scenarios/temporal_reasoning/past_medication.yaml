# Scenario: Past vs Current Medication
#
# Description:
#   Tests that the agent correctly distinguishes between past and current
#   medications, tracking temporal context properly.

id: past_medication_reasoning
name: "Past vs Current Medication Distinction"
description: |
  Verifica que el agente distingue correctamente entre medicamentos pasados
  y actuales, manejando el contexto temporal apropiadamente.
category: temporal_reasoning
severity: medium
tags:
  - temporal
  - medication
  - context

initial_state:
  fixture: diabetic_patient  # Use the diabetic patient fixture

turns:
  - turn: 1
    patient_message: "Antes tomaba Glibenclamida pero ahora solo tomo la Metformina"
    expected_intent: medication_update

    response_assertions:
      deterministic:
        - type: not_empty
          reason: "Agent should respond to the medication update"

      llm_judge:
        - criterion: temporal_understanding
          rubric: |
            Patient indicates they USED to take Glibenclamida but now only take
            Metformina. The agent should:
            - Acknowledge the medication change
            - Understand "antes" (before) vs "ahora" (now)
            - May ask about why the medication was changed
            Score 5 if agent clearly understands the temporal distinction.
          min_score: 4

    state_assertions:
      # Glibenclamida should be marked as past/discontinued
      entities_must_exist:
        - name: "Glibenclamida"
          type: "Medication"
          reason: "Glibenclamida should be recorded as past medication"

      # Check temporal property
      entity_property_check:
        - name: "Glibenclamida"
          property: "active"
          expected: false
          reason: "Glibenclamida should be marked as inactive/past"

      # Metformina should remain active (from fixture)
      entity_property_check:
        - name: "Metformina"
          property: "active"
          expected: true
          reason: "Metformina should remain active"

  - turn: 2
    patient_message: "Dejé de tomar el Losartán hace 2 semanas"
    expected_intent: medication_discontinuation

    response_assertions:
      deterministic:
        - type: must_contain
          values:
            - "Losartán"
          reason: "Agent should acknowledge the discontinued medication"

      llm_judge:
        - criterion: discontinuation_handling
          rubric: |
            Patient reports stopping Losartán 2 weeks ago. Agent should:
            - Acknowledge the discontinuation
            - May ask about the reason or doctor's instructions
            - Update the medication status appropriately
          min_score: 3

    state_assertions:
      # Losartán should be marked as discontinued
      entity_property_check:
        - name: "Losartán"
          property: "active"
          expected: false
          reason: "Losartán should be marked as discontinued"

      # Should have temporal metadata
      entity_property_check:
        - name: "Losartán"
          property: "status"
          expected: "discontinued"
          reason: "Losartán status should be discontinued"

  - turn: 3
    patient_message: "Ahora el doctor me recetó Enalapril en lugar del Losartán"
    expected_intent: medication_replacement

    response_assertions:
      deterministic:
        - type: must_contain
          values:
            - "Enalapril"
          reason: "Agent should acknowledge the new medication"

    state_assertions:
      entities_must_exist:
        - name: "Enalapril"
          type: "Medication"
          reason: "Enalapril should be added as new medication"

      entity_property_check:
        - name: "Enalapril"
          property: "active"
          expected: true
          reason: "Enalapril should be marked as active"

      # Verify replacement relationship
      relationships_must_exist:
        - from_name: "Enalapril"
          to_name: "Losartán"
          type_name: "REPLACES"
          reason: "Enalapril replaces Losartán relationship should exist"
