# Scenario: Muriel Bug Regression Test
# Bug ID: MURIEL-001
#
# Description:
#   Patient typed "Muriel" (typo) when trying to report a medication.
#   The agent incorrectly accepted this as a valid medication name and
#   stored it in memory, causing silent memory pollution.
#
# Expected behavior:
#   The agent should:
#   1. Recognize that "Muriel" is not a known medication
#   2. Ask for clarification or suggest corrections
#   3. NOT store "Muriel" as a medication in memory

id: muriel_bug_regression
name: "Muriel Typo Medication Bug"
description: |
  Regression test for the Muriel bug where a patient typo was incorrectly
  stored as a medication. This is a critical bug that caused silent memory
  pollution - the agent accepted any text as a valid medication without
  validation.
category: regression
severity: critical
tags:
  - medication
  - typo
  - memory_pollution
  - validation
created_from_bug: "MURIEL-001"

# Start with a clean patient state
initial_state:
  patient_id: null  # Generate unique ID

turns:
  - turn: 1
    patient_message: "Estoy tomando Muriel para mi problema de est칩mago"
    expected_intent: medication_report

    response_assertions:
      deterministic:
        # The agent should NOT simply acknowledge "Muriel" as a medication
        - type: must_not_contain
          values:
            - "Muriel est치 registrada"
            - "He registrado Muriel"
            - "Muriel a침adida"
          reason: "Agent must not confirm Muriel as a valid medication"

        # The agent should ask for clarification
        - type: must_contain
          values:
            - "?"  # Should contain a question mark (asking for clarification)
          reason: "Agent should ask a clarifying question about the unknown medication"

      llm_judge:
        - criterion: clarification_request
          rubric: |
            The agent should recognize that "Muriel" is not a valid medication name
            and ask the patient for clarification. Possible responses include:
            - Asking if they meant a different medication (e.g., Omeprazol, Melox)
            - Asking them to spell or describe the medication
            - Expressing uncertainty about the medication name
            Score 1-5 where 5 means clear clarification request, 1 means blind acceptance.
          min_score: 4

    state_assertions:
      # CRITICAL: "Muriel" should NOT be stored as a medication
      entities_must_not_exist:
        - name: "Muriel"
          type: "Medication"
          reason: "Muriel is a typo, not a valid medication - must not be stored"

        - name_pattern: "(?i)muriel"
          reason: "Any variation of Muriel should not be stored"

      # No unexpected memory writes should occur
      memory_diff_check:
        max_unexpected_entities: 0
        max_unexpected_relationships: 0
        reason: "No entities should be created from an unverified typo"

  - turn: 2
    patient_message: "Perd칩n, quise decir Omeprazol"
    expected_intent: medication_correction

    response_assertions:
      deterministic:
        - type: must_contain
          values:
            - "Omeprazol"
          reason: "Agent should acknowledge the correct medication name"

      llm_judge:
        - criterion: medication_acknowledgment
          rubric: |
            The agent should properly acknowledge Omeprazol as the corrected
            medication and may ask follow-up questions about dosage or frequency.
          min_score: 3

    state_assertions:
      # Omeprazol SHOULD be stored (corrected medication)
      entities_must_exist:
        - name: "Omeprazol"
          type: "Medication"
          reason: "Omeprazol is a valid medication that was clarified by the patient"

      # Muriel should STILL not exist (even after correction)
      entities_must_not_exist:
        - name: "Muriel"
          type: "Medication"
          reason: "Even after correction, Muriel should never have been stored"
